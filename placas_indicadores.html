<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Placas/Indicadores | VIA Group</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#0f4fa8">
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' y1='0' x2='1' y2='1'%3E%3Cstop stop-color='%230f4fa8'/%3E%3Cstop offset='1' stop-color='%232fa4ff'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='64' height='64' rx='16' fill='url(%23g)'/%3E%3Cpath d='M16 18l16 32 16-32' fill='none' stroke='%23fff' stroke-width='8' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

<!-- Chart + XLSX (para não quebrar gráfico/import) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
:root {
  --azul-escuro: #0b1c3d;
  --azul: #0f4fa8;
  --azul-claro: #2fa4ff;
  --branco: #ffffff;
  --cinza: #f4f6f9;
  --glass: rgba(255,255,255,0.78);
  --glass-strong: rgba(255,255,255,0.9);
  --shadow: 0 35px 90px rgba(0,0,0,0.14);
}

* { box-sizing: border-box; font-family: 'Inter', sans-serif; }

body {
  margin: 0;
  min-height: 100vh;
  background: linear-gradient(135deg, #eaf2ff, #ffffff);
  display: flex;
  align-items: center;
  justify-content: center;
  overflow-x: hidden;
}

.container {
  width: 100%;
  max-width: 980px;
  background: var(--glass);
  backdrop-filter: blur(18px);
  border-radius: 26px;
  box-shadow: var(--shadow);
  animation: fadeIn 0.8s ease;
  position: relative;
  overflow: hidden;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(20px); }
  to   { opacity: 1; transform: translateY(0); }
}

/* ===== TOP TABS (IGUAL OUTRA TELA) ===== */
.top-tabs {
  display: flex;
  gap: 10px;
  padding: 14px 16px;
  border-bottom: 1px solid rgba(15,79,168,0.12);
  background:
    radial-gradient(700px 220px at 20% 0%, rgba(47,164,255,0.18), transparent 60%),
    linear-gradient(180deg, rgba(255,255,255,0.88), rgba(255,255,255,0.62));
  backdrop-filter: blur(18px);
}

.top-tab {
  flex: 1;
  border: 0;
  cursor: pointer;
  padding: 12px 14px;
  border-radius: 18px;
  background: rgba(255,255,255,0.70);
  border: 1px solid rgba(15,79,168,0.10);
  box-shadow: 0 16px 44px rgba(0,0,0,0.06);
  transition: all .35s ease;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  color: rgba(11,28,61,0.80);
  font-weight: 900;
  letter-spacing: .2px;
  user-select: none;
}

.top-tab svg{
  width: 18px;
  height: 18px;
  color: rgba(11,28,61,0.75);
}

.top-tab:hover{
  transform: translateY(-2px);
  border-color: rgba(47,164,255,0.42);
  box-shadow: 0 22px 65px rgba(15,79,168,0.14);
}
.top-tab:active{ transform: scale(0.98); }

.top-tab.active{
  color: var(--azul-escuro);
  background: linear-gradient(135deg, rgba(15,79,168,0.14), rgba(47,164,255,0.14));
  border-color: rgba(15,79,168,0.25);
  box-shadow: 0 26px 80px rgba(15,79,168,0.16);
}
.top-tab.active svg{ color: var(--azul); }

/* container interno */
.app-wrap { width: 100%; }

/* ===== GRID app ===== */
.app {
  display: grid;
  grid-template-columns: 240px 1fr;
  min-height: 640px;
}

/* ===== SIDEBAR ===== */
.sidebar {
  position: relative;
  padding: 20px 16px;
  border-right: 1px solid rgba(15,79,168,0.12);
  background:
    radial-gradient(700px 420px at 20% 10%, rgba(47,164,255,0.20), transparent 60%),
    linear-gradient(180deg, rgba(255,255,255,0.85), rgba(255,255,255,0.60));
  backdrop-filter: blur(18px);
}
.sidebar::after{
  content:"";
  position:absolute;
  inset: -60px -80px auto auto;
  width: 260px;
  height: 260px;
  background: radial-gradient(circle at 30% 30%, rgba(47,164,255,0.28), rgba(15,79,168,0.10), transparent 62%);
  filter: blur(2px);
  pointer-events:none;
}

.brand {
  display: grid;
  gap: 12px;
  padding: 8px 10px 16px;
  border-radius: 18px;
}
.brand .logo {
  display:flex;
  align-items:center;
  justify-content:flex-start;
  gap: 10px;
}
.brand .logo img { width: 156px; }

.brand .meta {
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 10px;
  padding: 10px 12px;
  border-radius: 16px;
  background: rgba(255,255,255,0.72);
  border: 1px solid rgba(15,79,168,0.10);
  box-shadow: 0 18px 45px rgba(0,0,0,0.06);
}
.brand .meta b{
  font-size: 12px;
  color: var(--azul-escuro);
  letter-spacing: 0.2px;
}
.brand .pill{
  display:inline-flex;
  align-items:center;
  gap: 8px;
  padding: 8px 10px;
  border-radius: 999px;
  border: 1px solid rgba(47,164,255,0.25);
  background: linear-gradient(135deg, rgba(15,79,168,0.10), rgba(47,164,255,0.14));
  color: var(--azul);
  font-size: 12px;
  font-weight: 800;
}
.pulse-mini {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--azul);
  box-shadow: 0 0 0 0 rgba(47,164,255,0.55);
  animation: pulse 1.2s infinite;
  flex: 0 0 auto;
}
@keyframes pulse {
  0% { box-shadow: 0 0 0 0 rgba(47,164,255,0.55); transform: scale(0.95); }
  70% { box-shadow: 0 0 0 12px rgba(47,164,255,0); transform: scale(1); }
  100% { box-shadow: 0 0 0 0 rgba(47,164,255,0); transform: scale(0.98); }
}

.nav {
  margin-top: 14px;
  display: grid;
  gap: 10px;
  padding: 0 6px;
}
.nav-title {
  margin: 10px 8px 6px;
  font-size: 11px;
  font-weight: 800;
  letter-spacing: .7px;
  color: rgba(11,28,61,0.62);
  text-transform: uppercase;
}
.nav-btn{
  width: 100%;
  border: 0;
  cursor: pointer;
  text-align: left;
  padding: 12px 12px;
  border-radius: 18px;
  background: rgba(255,255,255,0.68);
  border: 1px solid rgba(15,79,168,0.10);
  box-shadow: 0 16px 44px rgba(0,0,0,0.06);
  transition: all .35s ease;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 12px;
  position: relative;
  overflow: hidden;
}
.nav-btn::before{
  content:"";
  position:absolute;
  inset: 0;
  background: radial-gradient(520px 160px at 0% 50%, rgba(47,164,255,0.22), transparent 60%);
  opacity: 0;
  transition: opacity .35s ease;
  pointer-events:none;
}
.nav-btn:hover{
  transform: translateY(-2px);
  border-color: rgba(47,164,255,0.42);
  box-shadow: 0 22px 65px rgba(15,79,168,0.14);
}
.nav-btn:hover::before{ opacity: 1; }
.nav-btn:active{ transform: scale(0.98); }

.nav-left{
  display:flex;
  align-items:center;
  gap: 10px;
  min-width: 0;
}
.nav-ico{
  width: 38px;
  height: 38px;
  border-radius: 14px;
  display:grid;
  place-items:center;
  background: linear-gradient(135deg, rgba(15,79,168,0.12), rgba(47,164,255,0.14));
  border: 1px solid rgba(47,164,255,0.28);
  color: var(--azul);
  transition: all .35s ease;
}
.nav-btn:hover .nav-ico{
  transform: rotate(-2deg) scale(1.04);
  border-color: rgba(47,164,255,0.5);
  box-shadow: 0 14px 35px rgba(47,164,255,0.18);
}
.nav-label{
  display:grid;
  gap: 3px;
  min-width: 0;
}
.nav-label b{
  font-size: 13px;
  font-weight: 900;
  color: var(--azul-escuro);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.nav-label span{
  font-size: 11.5px;
  color: rgba(75,93,130,0.85);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.nav-chip{
  font-size: 11px;
  font-weight: 900;
  color: rgba(11,28,61,0.72);
  padding: 8px 10px;
  border-radius: 999px;
  border: 1px solid rgba(11,28,61,0.10);
  background: rgba(255,255,255,0.62);
}
.nav-btn.active{
  background: linear-gradient(135deg, rgba(15,79,168,0.14), rgba(47,164,255,0.14));
  border-color: rgba(15,79,168,0.25);
  box-shadow: 0 26px 80px rgba(15,79,168,0.16);
}
.nav-btn.active .nav-chip{
  color: var(--azul);
  border-color: rgba(47,164,255,0.35);
  background: rgba(255,255,255,0.75);
}

.sidebar-footer{
  margin-top: 14px;
  padding: 10px 12px;
  border-radius: 18px;
  border: 1px solid rgba(15,79,168,0.10);
  background: rgba(255,255,255,0.62);
  color: rgba(91,107,139,0.95);
  font-size: 11.5px;
  box-shadow: 0 16px 44px rgba(0,0,0,0.06);
}

/* ===== CONTENT ===== */
.content {
  padding: 34px 34px 28px;
  position: relative;
}

h1 {
  text-align: center;
  color: var(--azul-escuro);
  font-size: 28px;
  font-weight: 700;
  margin: 0 0 6px;
}
.subtitle {
  text-align: center;
  color: #5b6b8b;
  font-size: 14px;
  margin-bottom: 26px;
}

/* ===== TELAS ===== */
.screen { display: none; }
.screen.active {
  display: block;
  animation: screenIn 360ms ease-out;
}
@keyframes screenIn {
  from { opacity: 0; transform: translateY(10px); }
  to   { opacity: 1; transform: translateY(0); }
}
@media (prefers-reduced-motion: reduce) { .screen.active { animation: none; } }

/* ===== IFRAME / EMBED ===== */
.embed-card{
  background: var(--glass-strong);
  border: 1px solid #d9e2ef;
  border-radius: 18px;
  padding: 14px;
  box-shadow: 0 18px 50px rgba(0,0,0,0.08);
}
.embed-frame{
  width: 100%;
  height: 72vh;
  border: 0;
  border-radius: 14px;
}

/* ===== RESPONSIVO ===== */
@media (max-width: 920px){
  .container{ max-width: 92vw; }
  .app{ grid-template-columns: 220px 1fr; }
}
@media (max-width: 760px){
  body{ align-items: flex-start; padding: 14px; }
  .app{ grid-template-columns: 1fr; }
  .sidebar{ border-right: 0; border-bottom: 1px solid rgba(15,79,168,0.12); }
  .content{ padding: 22px 18px 18px; }
  .nav{ grid-template-columns: 1fr 1fr; }
  .nav-title{ display:none; }
  .top-tabs { padding: 12px 12px; }
}

/* ===== status pill (online/offline) ===== */
.pill.offline {
  background: #ffecec !important;
  color: #9b1c1c !important;
  border-color: #ffb3b3 !important;
  font-weight: 800;
}
.pill.online {
  background: linear-gradient(135deg, rgba(15,79,168,0.10), rgba(47,164,255,0.14));
  color: var(--azul);
}

/* =========================================================
   [B] PLACAS/INDICADORES (telas nativas)
   ========================================================= */
.sf-actions-row .btn,
.sf-actions-row button,
.sf-inline-upload .btn,
.sf-inline-upload button{
  width: auto !important;
  padding: 12px 14px !important;
  border-radius: 14px !important;
  font-size: 13px !important;
}
#TelaPlacasHistorico, #TelaIndicadorFalha{ margin-top: 6px; }
.sf-card{ overflow: hidden; }
@media (max-width: 760px){ .embed-frame{ height: 65vh; } }

/* ===== Toast ===== */
.sf-toast{
  position: fixed;
  bottom: 18px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 999999;
  min-width: min(820px, 92vw);
  display:none;
  padding: 12px 14px;
  border-radius: 16px;
  border: 1px solid rgba(11,28,61,0.10);
  background: rgba(255,255,255,0.92);
  box-shadow: 0 20px 70px rgba(0,0,0,0.16);
  color: rgba(11,28,61,0.84);
  font-size: 13px;
  font-weight: 700;
  backdrop-filter: blur(14px);
}
.sf-toast.show{ display:block; animation: toastIn 180ms ease-out; }
@keyframes toastIn{ from{opacity:0; transform:translateX(-50%) translateY(8px)} to{opacity:1; transform:translateX(-50%) translateY(0)} }
.sf-toast small{ display:block; margin-top:2px; font-weight:600; color:#5b6b8b; }
.sf-toast.err{ border-color: rgba(176,0,32,0.18); background: rgba(255,245,245,0.96); color:#9b1c1c; }
.sf-toast.ok{ border-color: rgba(31,138,58,0.18); background: rgba(239,251,242,0.96); color:#1a6b2f; }
</style>

<style>
  :root{
    --azul:#2fa4ff;
    --azul-escuro:#0f4fa8;
    --glass-strong: rgba(255,255,255,0.78);
  }

  .sf-card{
    background: var(--glass-strong);
    border: 1px solid #d9e2ef;
    border-radius: 18px;
    padding: 18px;
    margin-bottom: 16px;
    box-shadow: 0 18px 50px rgba(0,0,0,0.08);
  }
  .sf-card-head{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap: 12px;
    margin-bottom: 12px;
  }
  .sf-muted{ color:#5b6b8b; font-size:12px; }

  .sf-h1{
    margin: 0 0 6px;
    font-size: 22px;
    font-weight: 900;
    color: var(--azul-escuro);
    letter-spacing: .2px;
  }
  .sf-subtitle{
    margin: 0 0 14px;
    font-size: 13px;
    color: rgba(11,28,61,0.66);
    font-weight: 700;
  }

  .btn{
    border: 0;
    border-radius: 16px;
    padding: 12px 14px;
    cursor:pointer;
    font-weight: 900;
    font-size: 13px;
    color: #fff;
    background: linear-gradient(135deg, rgba(15,79,168,0.88), rgba(47,164,255,0.88));
    box-shadow: 0 18px 52px rgba(0,0,0,0.10);
    transition: transform .18s ease, filter .18s ease;
    user-select: none;
  }
  .btn:hover{ transform: translateY(-1px); filter: brightness(1.03); }
  .btn.secondary{
    background: rgba(255,255,255,0.76);
    color: rgba(11,28,61,0.80);
    border: 1px solid rgba(15,79,168,0.12);
    box-shadow: 0 16px 44px rgba(0,0,0,0.06);
  }

  .sf-seg{ display:flex; gap:10px; margin:0 0 14px; }
  .sf-seg-btn{
    flex:1;
    border:1px solid rgba(15,79,168,0.12);
    background: rgba(255,255,255,0.75);
    border-radius: 16px;
    padding: 12px 14px;
    cursor:pointer;
    font-weight: 900;
    color: rgba(11,28,61,0.84);
    transition: all .25s ease;
    box-shadow: 0 14px 40px rgba(0,0,0,0.06);
  }
  .sf-seg-btn:hover{ transform: translateY(-1px); border-color: rgba(47,164,255,0.35); }
  .sf-seg-btn.active{
    background: linear-gradient(135deg, rgba(15,79,168,0.14), rgba(47,164,255,0.14));
    border-color: rgba(15,79,168,0.25);
    color: var(--azul-escuro);
  }
  .sf-view{ display:none; }
  .sf-view.active{ display:block; animation: sfIn 260ms ease-out; }
  @keyframes sfIn{ from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:translateY(0)} }

  .sf-actions-row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  .sf-inline-upload{
    display:flex; align-items:center; gap:8px;
    padding:10px 12px;
    border-radius:16px;
    border:1px solid rgba(15,79,168,0.10);
    background: rgba(255,255,255,0.68);
    box-shadow: 0 14px 40px rgba(0,0,0,0.06);
  }
  .sf-inline-label{ font-size:12px; font-weight:900; color: rgba(11,28,61,0.8); }
  .sf-inline-upload input{ width:220px; max-width:44vw; }
  .sf-small-note{
    margin-top:10px;
    font-size:12px;
    color:#6c7a99;
  }
  .sf-small-note code{
    padding:2px 6px;
    border-radius:10px;
    background: rgba(11,28,61,0.06);
    border: 1px solid rgba(11,28,61,0.08);
  }

  .sf-form{ display:grid; gap:12px; }
  .sf-field{ display:grid; gap:8px; }
  .sf-label{ font-size:13px; font-weight:800; color: var(--azul-escuro); }
  .sf-input{
    width:100%;
    padding: 12px 14px;
    border-radius: 14px;
    border: 1px solid #d9e2ef;
    outline:none;
    background:#fff;
    color: rgba(11,28,61,0.88);
    font-size: 14px;
  }
  .sf-input:focus{
    border-color: var(--azul);
    box-shadow: 0 0 0 4px rgba(47,164,255,0.22);
  }

  .sf-table-wrap{
    max-height: 52vh;
    overflow:auto;
    border-radius:16px;
    border:1px solid rgba(15,79,168,0.10);
    background:#fff;
  }
  .sf-table{ width:100%; border-collapse:collapse; font-size:13px; }
  .sf-table th, .sf-table td{
    padding:12px;
    border-bottom:1px solid rgba(11,28,61,0.06);
    text-align:left;
    white-space:nowrap;
  }
  .sf-table th{
    position:sticky; top:0; z-index:2;
    background:#f7f9ff;
    font-weight:900;
    color: rgba(11,28,61,0.84);
  }
  .sf-row{ cursor:pointer; }
  .sf-row:hover{ background: rgba(47,164,255,0.08); }

  .sf-pill{
    display:inline-flex; align-items:center; gap:8px;
    padding:7px 10px;
    border-radius:999px;
    font-size:12px;
    font-weight:900;
    border:1px solid rgba(11,28,61,0.10);
    background: rgba(255,255,255,0.7);
    color: rgba(11,28,61,0.72);
  }
  .sf-pill .dot{ width:8px; height:8px; border-radius:50%; background: rgba(11,28,61,0.24); }
  .sf-pill.red{ border-color: rgba(176,0,32,0.25); color:#9b1c1c; background:#fff5f5; }
  .sf-pill.red .dot{ background:#b00020; }
  .sf-pill.orange{ border-color: rgba(255,140,0,0.22); color:#8a4a00; background:#fff7e8; }
  .sf-pill.orange .dot{ background:#ff8c00; }
  .sf-pill.green{ border-color: rgba(0,128,0,0.22); color:#1a6b2f; background:#effbf2; }
  .sf-pill.green .dot{ background:#1f8a3a; }

  .sf-grid-3{ display:grid; grid-template-columns: 1fr 1.8fr 1.8fr; gap:14px; }
  .sf-grid-2{ display:grid; grid-template-columns: 1fr 1.3fr; gap:14px; }
  .sf-span-2{ grid-column: span 2; }

  .sf-ind-head{
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap:14px;
    margin-bottom:14px;
  }
  .sf-toggle{ display:flex; gap:8px; }
  .sf-toggle-btn{
    border:1px solid rgba(15,79,168,0.12);
    background: rgba(255,255,255,0.75);
    border-radius:999px;
    padding:10px 12px;
    cursor:pointer;
    font-weight:900;
    font-size:12px;
    color: rgba(11,28,61,0.78);
  }
  .sf-toggle-btn.active{
    background: linear-gradient(135deg, rgba(15,79,168,0.14), rgba(47,164,255,0.14));
    border-color: rgba(15,79,168,0.25);
    color: var(--azul-escuro);
  }

  .sf-kpi-row{
    display:grid;
    grid-template-columns: 1.4fr 1fr 1fr 1fr;
    gap:12px;
    margin-bottom:14px;
  }
  .sf-kpi{
    border-radius:18px;
    border:1px solid rgba(15,79,168,0.10);
    background: rgba(255,255,255,0.72);
    box-shadow:0 16px 44px rgba(0,0,0,0.06);
    padding:14px;
  }
  .sf-kpi-label{ font-size:12px; font-weight:900; color: rgba(11,28,61,0.62); }
  .sf-kpi-value{ margin-top:6px; font-size:28px; font-weight:900; color: var(--azul-escuro); }
  .sf-kpi-sub{ margin-top:2px; font-size:12px; color:#5b6b8b; }
  .sf-kpi-bar{ margin-top:10px; height:12px; border-radius:999px; background: rgba(11,28,61,0.08); overflow:hidden; }
  .sf-kpi-fill{ height:100%; width:0%; border-radius:999px; background: linear-gradient(90deg, rgba(47,164,255,0.75), rgba(15,79,168,0.85)); transition: width .25s ease; }

  .sf-red{ color:#b00020; }
  .sf-orange{ color:#ff8c00; }
  .sf-green{ color:#1f8a3a; }

  .sf-ind-grid{ display:grid; grid-template-columns: 1.15fr 0.85fr; gap:14px; align-items:start; }
  .sf-chart-wrap{
    border-radius:16px;
    border:1px solid rgba(15,79,168,0.10);
    background:#fff;
    padding:10px;
  }

  .sf-list{
    border-radius:16px;
    border:1px solid rgba(15,79,168,0.10);
    background: rgba(255,255,255,0.78);
    padding:12px;
    margin-bottom:12px;
  }
  .sf-list-head{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    margin-bottom:10px;
  }
  .sf-dot{ width:10px; height:10px; border-radius:50%; }
  .sf-dot-red{ background:#b00020; }
  .sf-dot-orange{ background:#ff8c00; }
  .sf-dot-green{ background:#1f8a3a; }
  .sf-badge{
    font-size:11px; font-weight:900;
    padding:6px 10px; border-radius:999px;
    border:1px solid rgba(11,28,61,0.10);
    background: rgba(255,255,255,0.7);
    color: rgba(11,28,61,0.72);
  }
  .sf-list-body{ display:grid; gap:8px; max-height: 34vh; overflow:auto; padding-right:4px; }
  .sf-item{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    padding:10px; border-radius:14px;
    background:#fff; border:1px solid rgba(11,28,61,0.08);
  }
  .sf-item .left{ display:grid; gap:2px; }
  .sf-item b{ font-size:12.5px; color: rgba(11,28,61,0.86); }
  .sf-item span{ font-size:11.5px; color:#5b6b8b; }
  .sf-item .since{ font-size:11px; color:#5b6b8b; opacity:0.95; }
  .sf-modal{ position:fixed; inset:0; z-index:999999; display:none; align-items:center; justify-content:center; }
  .sf-modal.show{ display:flex; }
  .sf-modal-backdrop{ position:absolute; inset:0; background: rgba(11,28,61,0.45); backdrop-filter: blur(6px); }
  .sf-modal-card{
    position:relative;
    width:min(980px, 92vw);
    margin:6vh auto;
    border-radius:22px;
    background: var(--glass-strong);
    border:1px solid rgba(255,255,255,0.25);
    box-shadow:0 40px 110px rgba(0,0,0,0.22);
    overflow:hidden;
  }
  .sf-modal-head{
    display:flex; justify-content:space-between; align-items:flex-start; gap:12px;
    padding:16px 18px;
    border-bottom:1px solid rgba(15,79,168,0.12);
    background: linear-gradient(180deg, rgba(255,255,255,0.92), rgba(255,255,255,0.72));
  }
  .sf-modal-title{ font-weight:900; font-size:16px; color: var(--azul-escuro); }
  .sf-x{
    width:40px; height:40px; border-radius:14px;
    border:1px solid rgba(11,28,61,0.10);
    background: rgba(255,255,255,0.72);
    cursor:pointer;
    font-size:22px; font-weight:900;
    color: rgba(11,28,61,0.70);
  }
  .sf-modal-body{ padding:16px 18px 18px; }
  .sf-error{
    margin-top:10px;
    background:#fff5f5;
    border:1px solid #ffd1d1;
    color:#9b1c1c;
    border-radius:16px;
    padding:12px 14px;
    font-size:13px;
    display:none;
  }

  /* ===== Fullscreen indicador ===== */
  #sfIndicatorPanel.sf-fullscreen{
    position: fixed;
    inset: 14px;
    z-index: 999998;
    margin: 0;
    overflow:auto;
  }
  .sf-full-close{
    position:absolute;
    top:12px; right:12px;
    padding:10px 14px;
    border-radius:14px;
    border:1px solid rgba(11,28,61,0.10);
    background: rgba(255,255,255,0.86);
    cursor:pointer;
    font-weight:900;
    color: rgba(11,28,61,0.74);
    display:none;
  }

  @media (max-width: 1060px){
    .sf-grid-3{ grid-template-columns: 1fr; }
    .sf-span-2{ grid-column:auto; }
    .sf-grid-2{ grid-template-columns: 1fr; }
    .sf-ind-grid{ grid-template-columns: 1fr; }
    .sf-kpi-row{ grid-template-columns: 1fr 1fr; }
  }
</style>
</head>

<body>
<div class="container">

  <div class="top-tabs" role="tablist" aria-label="Abas principais">
    <button class="top-tab" type="button" id="goSuporte" title="Voltar para Suporte">
      <!-- Ícone (igual padrão da outra tela: svg direto) -->
      <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
        <circle cx="12" cy="12" r="4" stroke="currentColor" stroke-width="2"/>
        <path d="M4.93 4.93l4.24 4.24" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <path d="M14.83 14.83l4.24 4.24" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <path d="M14.83 9.17l4.24-4.24" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <path d="M9.17 14.83l-4.24 4.24" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
      Suporte
    </button>

    <button class="top-tab" type="button" id="goDiversos" title="Voltar para Diversos">
      <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M12 2l1.2 4.2L17 8l-3.8 1.8L12 14l-1.2-4.2L7 8l3.8-1.8L12 2Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
        <path d="M5 14l.7 2.4L8 17l-2.3 1-.7 2.4-.7-2.4L2 17l2.3-.6L5 14Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
        <path d="M19 13l.8 2.8L22 16l-2.2 1-.8 2.8-.8-2.8L16 16l2.2-.2L19 13Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
      </svg>
      Diversos
    </button>

    <button class="top-tab active" type="button" aria-selected="true">
      <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M3 16l1-6a3 3 0 0 1 3-2h10a3 3 0 0 1 3 2l1 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <path d="M5 16h14v3a1 1 0 0 1-1 1h-1" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <path d="M5 20H4a1 1 0 0 1-1-1v-3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <circle cx="7.5" cy="16.5" r="1.5" fill="currentColor"/>
        <circle cx="16.5" cy="16.5" r="1.5" fill="currentColor"/>
      </svg>
      Placas/Indicadores
    </button>
  </div>

  <div class="app-wrap">
    <div class="app" id="appPlacas">

      <aside class="sidebar">
        <div class="brand">
          <div class="logo">
            <img src="https://viagroup.com.br/assets/via_group-22fac685.png" alt="VIA Group">
          </div>
          <div class="meta">
            <b>Status</b>
            <div class="pill"><span class="pulse-mini"></span>online</div>
          </div>
        </div>

        <div class="nav-title">Módulos</div>

        <nav class="nav" aria-label="Navegação Placas/Indicadores">
          <button class="nav-btn active" type="button" data-tab="indicador_suporte">
            <div class="nav-left">
              <div class="nav-ico" aria-hidden="true"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M4 19V5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M8 19V9" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M12 19V12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M16 19V7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M20 19V10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg></div>
              <div class="nav-label">
                <b>Indicador Suporte</b>
                <span>Power BI (embed)</span>
              </div>
            </div>
            <div class="nav-chip">BI</div>
          </button>

          <button class="nav-btn" type="button" data-tab="indicador_alimentacao">
            <div class="nav-left">
              <div class="nav-ico" aria-hidden="true"><svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                <path d="M6 3v8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <path d="M4 3v4c0 2 4 2 4 0V3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M8 3v4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <path d="M16 3v10a4 4 0 0 0 4 4v4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M4 21h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg></div>
              <div class="nav-label">
                <b>Indicador Alimentação</b>
                <span>Power BI (embed)</span>
              </div>
            </div>
            <div class="nav-chip">BI</div>
          </button>

          <button class="nav-btn" type="button" data-tab="placas">
            <div class="nav-left">
              <div class="nav-ico" aria-hidden="true"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M8 6h13M8 12h13M8 18h13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M4 6h.01M4 12h.01M4 18h.01" stroke="currentColor" stroke-width="3" stroke-linecap="round"/></svg></div>
              <div class="nav-label">
                <b>Placas</b>
                <span>Filtro • Pesquisa • Histórico</span>
              </div>
            </div>
            <div class="nav-chip">PL</div>
          </button>

          <button class="nav-btn" type="button" data-tab="indicador_falha">
            <div class="nav-left">
              <div class="nav-ico" aria-hidden="true"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M2 8.5C6.5 4 17.5 4 22 8.5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M5 12c3-3 11-3 14 0" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M8.5 15.5c1.5-1.5 5.5-1.5 7 0" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><circle cx="12" cy="19" r="1.6" fill="currentColor"/></svg></div>
              <div class="nav-label">
                <b>Indicador Falha de Sinal</b>
                <span>Semanal + mensal</span>
              </div>
            </div>
            <div class="nav-chip">IND</div>
          </button>
        </nav>

        <div class="sidebar-footer">
          VIA Group • Placas &amp; Indicadores<br>
          <span style="opacity:.75">Histórico salvo em navegador (localStorage)</span>
        </div>
      </aside>

      <main class="content">

        <div class="screen active" id="screenIndicadorSuporte">
          <h1>Indicador Suporte</h1>
          <div class="subtitle">Visualização do Power BI (filtros e interações nativas do relatório)</div>

          <div class="embed-card">
            <iframe
              class="embed-frame"
              title="Indicador Suporte (Power BI)"
              src="https://app.powerbi.com/view?r=eyJrIjoiMDhhODc2ODItMGRkMC00OTlhLThjYzktYjIyN2M1NjI0MjZkIiwidCI6IjdkOTc1NGIzLWRjZGItNGVmZS04YmI3LWMwZTU1ODdiODZlZCJ9"
              allowfullscreen="true"
            ></iframe>
          </div>
        </div>

        <div class="screen" id="screenIndicadorAlimentacao">
          <h1>Indicador Alimentação</h1>
          <div class="subtitle">Visualização do Power BI (filtros e interações nativas do relatório)</div>

          <div class="embed-card">
            <iframe
              class="embed-frame"
              title="Indicador Alimentação (Power BI)"
              src="https://app.powerbi.com/view?r=eyJrIjoiOTIzZDU5OWEtOGIxZS00MjE1LWI2ZGQtZmEyOGQ5MDc5YjZlIiwidCI6IjdkOTc1NGIzLWRjZG-itNGVmZS04YmI3LWMwZTU1ODdiODZlZCJ9"
              allowfullscreen="true"
            ></iframe>
          </div>
        </div>

        <div class="screen" id="screenPlacasHistorico">
          <section id="TelaPlacasHistorico">
            <h2 class="sf-h1">Placas e Histórico</h2>
            <p class="sf-subtitle">Filtre por empresa, filial e placa • registre falhas • mantenha histórico</p>

            <div class="sf-seg" role="tablist" aria-label="Sub-abas Placas e Histórico">
              <button type="button" class="sf-seg-btn active" data-view="placas">Placas</button>
              <button type="button" class="sf-seg-btn" data-view="historico">Histórico</button>
            </div>

            <div class="sf-view active" id="sfViewPlacas">
              <div class="sf-card">
                <div class="sf-card-head">
                  <b>Base de Placas</b>
                  <span class="sf-muted" id="sfBaseStatus">—</span>
                </div>

                <div class="sf-actions-row">
                  <button class="btn secondary" type="button" id="sfBtnLoadRepo">Atualizar base (repositório)</button>

                  <div class="sf-inline-upload">
                    <label class="sf-inline-label">WIKI</label>
                    <input type="file" id="sfFileWiki" accept=".xlsx,.xls,.csv">
                  </div>

                  <div class="sf-inline-upload">
                    <label class="sf-inline-label">TELEMATIX</label>
                    <input type="file" id="sfFileTele" accept=".xlsx,.xls,.csv">
                  </div>
                </div>

                <div class="sf-small-note">
                  Se usar “Atualizar base (repositório)”, coloque os arquivos em
                  <code>/data/WIKIPLACAS.xlsx</code> e <code>/data/TELEMATIXPLACAS.xlsx</code>.
                </div>
              </div>

              <div class="sf-grid-3">
                <div class="sf-card">
                  <div class="sf-card-head"><b>Filtros</b><span class="sf-muted">Use 1 ou todos</span></div>

                  <div class="sf-form">
                    <div class="sf-field">
                      <label class="sf-label">Empresa</label>
                      <select class="sf-input" id="sfFilterEmpresa">
                        <option value="ALL">Todas</option>
                        <option value="WIKI">WIKI</option>
                        <option value="TELEMATIX">TELEMATIX</option>
                      </select>
                    </div>

                    <div class="sf-field">
                      <label class="sf-label">Filial (Garagem)</label>
                      <select class="sf-input" id="sfFilterFilial">
                        <option value="ALL">Todas</option>
                      </select>
                    </div>

                    <div class="sf-field">
                      <label class="sf-label">Pesquisar placa</label>
                      <input class="sf-input" id="sfFilterPlaca" placeholder="Ex.: ABC1 (busca parcial)" />
                    </div>

                    <button class="btn" type="button" id="sfBtnClearFilters">Limpar filtros</button>
                  </div>
                </div>

                <div class="sf-card sf-span-2">
                  <div class="sf-card-head">
                    <b>Lista de Placas</b>
                    <span class="sf-muted" id="sfListMeta">—</span>
                  </div>

                  <div class="sf-table-wrap">
                    <table class="sf-table">
                      <thead>
                        <tr>
                          <th>Placa</th>
                          <th>Filial</th>
                          <th>Empresa</th>
                          <th>Status</th>
                          <th>Início</th>
                          <th>Fim</th>
                        </tr>
                      </thead>
                      <tbody id="sfPlacasTbody"></tbody>
                    </table>
                  </div>

                  <div class="sf-small-note">Clique em uma linha para <b>registrar / atualizar</b> a falha de sinal.</div>
                </div>
              </div>
            </div>

            <div class="sf-view" id="sfViewHistorico">
              <div class="sf-grid-2">
                <div class="sf-card">
                  <div class="sf-card-head"><b>Filtro do histórico</b><span class="sf-muted">Opcional</span></div>

                  <div class="sf-form">
                    <div class="sf-field">
                      <label class="sf-label">Somente status</label>
                      <select class="sf-input" id="sfHistStatus">
                        <option value="ALL">Todos</option>
                        <option value="falha">Falha de sinal</option>
                        <option value="reportada">Falha reportada</option>
                        <option value="concluida">Resolvido</option>
                        <option value="removida">Removido</option>
                      </select>
                    </div>

                    <div class="sf-field">
                      <label class="sf-label">Pesquisar placa</label>
                      <input class="sf-input" id="sfHistPlaca" placeholder="Ex.: TBO2" />
                    </div>

                    <button class="btn secondary" type="button" id="sfBtnClearHist">Limpar</button>
                    <button class="btn" type="button" id="sfBtnExportHist">Exportar (JSON)</button>
                  </div>
                </div>

                <div class="sf-card">
                  <div class="sf-card-head"><b>Registros</b><span class="sf-muted" id="sfHistMeta">—</span></div>

                  <div class="sf-table-wrap">
                    <table class="sf-table">
                      <thead>
                        <tr>
                          <th>Data/Hora</th>
                          <th>Placa</th>
                          <th>Filial</th>
                          <th>Empresa</th>
                          <th>Ação</th>
                        </tr>
                      </thead>
                      <tbody id="sfHistTbody"></tbody>
                    </table>
                  </div>

                  <div class="sf-small-note">
                    Histórico registra todas as ações feitas. Por padrão fica em <code>localStorage</code>.
                  </div>
                </div>
              </div>
            </div>
          </section>
        </div>

        <div class="screen" id="screenIndicadorFalha">
          <section id="TelaIndicadorFalha">
            <h2 class="sf-h1">Indicador Falha de Sinal</h2>
            <p class="sf-subtitle">Semanal e mensal • % (regra 20 dias) • listas de placas por status</p>

            <div class="sf-card" id="sfIndicatorPanel">
              <div class="sf-ind-head">
                <div>
                  <div style="display:grid;gap:3px;">
                    <b>Porcentagem falha de sinal</b>
                    <span class="sf-muted" id="sfIndRange">—</span>
                  </div>

                  <div class="sf-toggle" style="margin-top:10px;">
                    <button type="button" class="sf-toggle-btn active" data-mode="weekly">Semanal</button>
                    <button type="button" class="sf-toggle-btn" data-mode="monthly">Mensal</button>
                  </div>
                </div>

                <div style="display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap;">
                  <div id="sfMonthWrap">
                    <label class="sf-label" style="margin:0 0 6px;">Mês</label>
                    <input class="sf-input" type="month" id="sfMonthPick">
                  </div>

                  <div id="sfWeekWrap">
                    <label class="sf-label" style="margin:0 0 6px;">Semana</label>
                    <select class="sf-input" id="sfWeekPick"></select>
                  </div>

                  <button class="btn secondary" type="button" id="sfBtnFull">Tela cheia</button>
                </div>
              </div>

              <div class="sf-kpi-row">
                <div class="sf-kpi">
                  <div class="sf-kpi-label">% (regra 20 dias)</div>
                  <div class="sf-kpi-value" id="sfPctValue">—</div>
                  <div class="sf-kpi-sub" id="sfPctSub">—</div>
                  <div class="sf-kpi-bar"><div class="sf-kpi-fill" id="sfPctFill"></div></div>
                </div>

                <div class="sf-kpi">
                  <div class="sf-kpi-label">Falha de sinal</div>
                  <div class="sf-kpi-value sf-red" id="sfCntFalha">—</div>
                </div>

                <div class="sf-kpi">
                  <div class="sf-kpi-label">Falha reportada</div>
                  <div class="sf-kpi-value sf-orange" id="sfCntReport">—</div>
                </div>

                <div class="sf-kpi">
                  <div class="sf-kpi-label">Resolvido</div>
                  <div class="sf-kpi-value sf-green" id="sfCntConcl">—</div>
                </div>
              </div>

              <div class="sf-ind-grid">
                <div class="sf-card">
                  <div class="sf-card-head">
                    <b id="sfChartTitle">Semanal</b>
                    <span class="sf-muted" id="sfChartHint">Contagem por status</span>
                  </div>

                  <div class="sf-chart-wrap" id="sfWeeklyWrap">
                    <canvas id="sfWeeklyChart" height="140"></canvas>
                  </div>

                  <div class="sf-chart-wrap" id="sfMonthlyWrap" style="display:none;">
                    <canvas id="sfMonthlyChart" height="220"></canvas>
                  </div>
                </div>

                <div class="sf-card">
                  <div class="sf-card-head"><b>Placas por status</b><span class="sf-muted">Atualiza conforme período</span></div>

                  <div class="sf-list">
                    <div class="sf-list-head">
                      <span class="sf-dot sf-dot-red"></span>
                      <b>Falha de sinal</b>
                      <span class="sf-badge" id="sfBadgeFalha">0</span>
                    </div>
                    <div class="sf-list-body" id="sfListFalha"></div>
                  </div>

                  <div class="sf-list">
                    <div class="sf-list-head">
                      <span class="sf-dot sf-dot-orange"></span>
                      <b>Falha reportada</b>
                      <span class="sf-badge" id="sfBadgeReport">0</span>
                    </div>
                    <div class="sf-list-body" id="sfListReport"></div>
                  </div>

                  <div class="sf-list">
                    <div class="sf-list-head">
                      <span class="sf-dot sf-dot-green"></span>
                      <b>Resolvido</b>
                      <span class="sf-badge" id="sfBadgeConcl">0</span>
                    </div>
                    <div class="sf-list-body" id="sfListConcl"></div>
                  </div>

                  <div class="sf-small-note">
                    Regra do %:
                    <b>0%</b> se existir <b>Falha (não reportada)</b> no período <u>ou</u> <b>Falha reportada</b> com <b>mais de 20 dias</b> (desde o início).
                    Caso contrário: <b>100%</b>.
                  </div>
                </div>
              </div>

              <button class="sf-full-close" type="button" id="sfBtnFullClose">Fechar</button>
            </div>
          </section>
        </div>

      </main>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="sf-toast" id="sfToast" role="status" aria-live="polite"></div>

<div class="sf-modal" id="sfModal" aria-hidden="true" >
  <div class="sf-modal-backdrop" data-close="1"></div>

  <div class="sf-modal-card" role="dialog" aria-modal="true" aria-labelledby="sfModalTitle">
    <div class="sf-modal-head">
      <div>
        <div class="sf-modal-title" id="sfModalTitle">Placa</div>
        <div class="sf-muted" id="sfModalSub">—</div>
      </div>
      <button class="sf-x" type="button" data-close="1" aria-label="Fechar">×</button>
    </div>

    <div class="sf-modal-body">
      <div class="sf-grid-2">
        <div class="sf-card" style="margin-bottom:0;">
          <div class="sf-card-head"><b>Status atual</b><span class="sf-muted" id="sfModalStatus">—</span></div>
          <div class="sf-muted"><b>Início:</b> <span id="sfModalInicio">—</span></div>
          <div class="sf-muted"><b>Fim:</b> <span id="sfModalFim">—</span></div>
        </div>

        <div class="sf-card" style="margin-bottom:0;">
          <div class="sf-card-head"><b>Ações</b><span class="sf-muted">Falha de Sinal</span></div>

          <div class="sf-form">
            <div class="sf-field" id="sfFieldInicio">
              <label class="sf-label">Data de início</label>
              <input class="sf-input" type="date" id="sfInputInicio">
            </div>

            <div class="sf-field" id="sfFieldFim" >
              <label class="sf-label">Data de fim</label>
              <input class="sf-input" type="date" id="sfInputFim">
            </div>

            <div style="display:grid; gap:10px;">
              <button class="btn" type="button" id="sfBtnAddFalha">Adicionar Falha</button>
              <button class="btn secondary" type="button" id="sfBtnReportar">Marcar Reportada</button>
              <button class="btn" type="button" id="sfBtnConcluir">Concluir</button>
              <button class="btn secondary" type="button" id="sfBtnRemover">Remover Falha</button>
            </div>

            <div class="sf-error" id="sfModalErr"></div>
          </div>
        </div>
      </div>

      <div class="sf-small-note">
        Regras do %: <b>0%</b> se existir <b>Falha</b> (não reportada) no período, ou se a <b>Falha reportada</b> estiver com <b>mais de 20 dias</b> (desde o início). Caso contrário: <b>100%</b>.
      </div>
    </div>
  </div>
</div>

<script>
/* ===========================
   NAV topo
=========================== */
const INDEX_PAGE = 'index.html';
document.getElementById('goSuporte').addEventListener('click', () => window.location.href = INDEX_PAGE + '?top=suporte');
document.getElementById('goDiversos').addEventListener('click', () => window.location.href = INDEX_PAGE + '?top=diversos');

/* ===========================
   Toast util
=========================== */
const Toast = (() => {
  const el = document.getElementById('sfToast');
  let t = null;
  const show = (msg, sub, type='') => {
    if (!el) return;
    el.classList.remove('err','ok','show');
    if (type === 'err') el.classList.add('err');
    if (type === 'ok') el.classList.add('ok');
    el.innerHTML = `${escapeHtml(msg)}${sub ? `<small>${escapeHtml(sub)}</small>` : ''}`;
    el.classList.add('show');
    clearTimeout(t);
    t = setTimeout(() => el.classList.remove('show'), 4200);
  };
  return { show };
})();

/* ===========================
   Status n8n
=========================== */
async function checkN8nStatus() {
  const pills = document.querySelectorAll('.brand .pill');
  if (!pills.length) return;

  try {
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 4000);

    const res = await fetch('https://n8n.datastack.viagroup.com.br/webhook/online', { signal: controller.signal });
    clearTimeout(timeout);
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const data = await res.json();

    if (data.status === 'online') {
      pills.forEach(pill => {
        pill.innerHTML = '<span class="pulse-mini"></span>online';
        pill.classList.remove('offline');
        pill.classList.add('online');
      });
    } else throw new Error('offline');
  } catch (e) {
    pills.forEach(pill => {
      pill.innerHTML = 'offline';
      pill.classList.remove('online');
      pill.classList.add('offline');
    });
  }
}
checkN8nStatus();
setInterval(checkN8nStatus, 60000);

/* ===========================
   Tabs sidebar (telas)
=========================== */
const navBtns = document.querySelectorAll('#appPlacas .nav-btn');
function setActiveTab(tab) {
  navBtns.forEach(b => b.classList.toggle('active', b.dataset.tab === tab));
  document.getElementById('screenIndicadorSuporte').classList.toggle('active', tab === 'indicador_suporte');
  document.getElementById('screenIndicadorAlimentacao').classList.toggle('active', tab === 'indicador_alimentacao');
  document.getElementById('screenPlacasHistorico').classList.toggle('active', tab === 'placas');
  document.getElementById('screenIndicadorFalha').classList.toggle('active', tab === 'indicador_falha');
  if (tab === 'indicador_falha') SF.renderIndicator();
}
navBtns.forEach(btn => btn.addEventListener('click', () => setActiveTab(btn.dataset.tab)));

/* ===========================
   BASE EMBED
=========================== */
window.SF_EMBED_BASE = window.SF_EMBED_BASE || { wiki: [], telematix: [] };

/* ===========================
   APP SF
=========================== */
const SF = (() => {
  const LS = { base: 'sf_base_v1', state: 'sf_state_v1', hist: 'sf_hist_v1' };

  // ---- utils
  const pad2 = n => String(n).padStart(2,'0');
  const todayISO = () => {
    const d = new Date();
    return d.getFullYear() + '-' + pad2(d.getMonth()+1) + '-' + pad2(d.getDate());
  };
  const fmtBR = (iso) => {
    if (!iso) return '—';
    const [y,m,d] = iso.split('-');
    if (!y || !m || !d) return '—';
    return `${d}/${m}/${y}`;
  };
  const normStr = (s) => String(s ?? '').trim();
  const normPlate = (s) => normStr(s).toUpperCase();

  // diff em dias (inclusive) usando UTC (não quebra por fuso/horário de verão)
  const isoToUTC = (iso) => {
    if (!iso || !String(iso).includes('-')) return null;
    const [y,m,d] = String(iso).split('-').map(Number);
    if (!y || !m || !d) return null;
    return new Date(Date.UTC(y, m-1, d));
  };
  const diffDaysInclusive = (startISO, endISO) => {
    const a = isoToUTC(startISO);
    const b = isoToUTC(endISO);
    if (!a || !b) return 0;
    const days = Math.floor((b.getTime() - a.getTime()) / 86400000) + 1;
    return Math.max(0, days);
  };

  // >>> FIX CRÍTICO: localStorage às vezes fica "null"
  const safeJSON = (s, fallback) => {
    try {
      const v = JSON.parse(s);
      return (v === null || v === undefined) ? fallback : v;
    } catch {
      return fallback;
    }
  };
  const ensureObj = (v) => (v && typeof v === 'object' && !Array.isArray(v)) ? v : {};
  const ensureArr = (v) => Array.isArray(v) ? v : [];

  const hasXLSX = () => !!(window.XLSX && typeof window.XLSX.read === 'function');

  const loadBase = () => {
    const saved = safeJSON(localStorage.getItem(LS.base), null);
    if (saved && typeof saved === 'object') {
      return {
        wiki: Array.isArray(saved.wiki) ? saved.wiki : [],
        telematix: Array.isArray(saved.telematix) ? saved.telematix : []
      };
    }
    return {
      wiki: Array.isArray(window.SF_EMBED_BASE.wiki) ? window.SF_EMBED_BASE.wiki : [],
      telematix: Array.isArray(window.SF_EMBED_BASE.telematix) ? window.SF_EMBED_BASE.telematix : []
    };
  };

  const saveBase = (base) => localStorage.setItem(LS.base, JSON.stringify(base));
  const loadState = () => ensureObj(safeJSON(localStorage.getItem(LS.state), {}));
  const saveState = (st) => localStorage.setItem(LS.state, JSON.stringify(st));
  const loadHist = () => ensureArr(safeJSON(localStorage.getItem(LS.hist), []));
  const saveHist = (h) => localStorage.setItem(LS.hist, JSON.stringify(h));

  const uniqBy = (arr, keyFn) => {
    const seen = new Set();
    const out = [];
    for (const it of arr) {
      const k = keyFn(it);
      if (seen.has(k)) continue;
      seen.add(k);
      out.push(it);
    }
    return out;
  };

  const mergeBaseToRows = (base) => {
    const rows = [];
    for (const it of (base.wiki || [])) rows.push({ placa: normPlate(it.placa), filial: normStr(it.filial), empresa: 'WIKI' });
    for (const it of (base.telematix || [])) rows.push({ placa: normPlate(it.placa), filial: normStr(it.filial), empresa: 'TELEMATIX' });
    return uniqBy(rows.filter(r => r.placa), r => r.empresa + '|' + r.placa);
  };

  const statusPillHTML = (status) => {
    if (status === 'falha') return `<span class="sf-pill red"><span class="dot"></span>Falha</span>`;
    if (status === 'reportada') return `<span class="sf-pill orange"><span class="dot"></span>Reportada</span>`;
    if (status === 'concluida') return `<span class="sf-pill green"><span class="dot"></span>Resolvida</span>`;
    return `<span class="sf-pill"><span class="dot"></span>OK</span>`;
  };

  const monthNames = ['JAN','FEV','MAR','ABR','MAI','JUN','JUL','AGO','SET','OUT','NOV','DEZ'];

  // Semanas do mês por faixa fixa
  const getWeekRangesInMonth = (year, month1to12) => {
    const lastDay = new Date(year, month1to12, 0).getDate();
    const ranges = [];
    const cuts = [
      { label:'S1', s:1, e:Math.min(7,lastDay) },
      { label:'S2', s:8, e:Math.min(14,lastDay) },
      { label:'S3', s:15, e:Math.min(21,lastDay) },
      { label:'S4', s:22, e:Math.min(28,lastDay) }
    ];
    for (const c of cuts) if (c.s <= lastDay) ranges.push(c);
    if (lastDay >= 29) ranges.push({ label:'S5', s:29, e:lastDay });
    return ranges;
  };

  const isoFromYMD = (y,m1,d) => `${y}-${pad2(m1)}-${pad2(d)}`;

  // UI refs
  const el = {
    segBtns: () => document.querySelectorAll('.sf-seg-btn'),
    views: { placas: document.getElementById('sfViewPlacas'), historico: document.getElementById('sfViewHistorico') },
    baseStatus: document.getElementById('sfBaseStatus'),
    listMeta: document.getElementById('sfListMeta'),
    tbodyPlacas: document.getElementById('sfPlacasTbody'),

    filterEmpresa: document.getElementById('sfFilterEmpresa'),
    filterFilial: document.getElementById('sfFilterFilial'),
    filterPlaca: document.getElementById('sfFilterPlaca'),
    btnClearFilters: document.getElementById('sfBtnClearFilters'),

    btnLoadRepo: document.getElementById('sfBtnLoadRepo'),
    fileWiki: document.getElementById('sfFileWiki'),
    fileTele: document.getElementById('sfFileTele'),

    histStatus: document.getElementById('sfHistStatus'),
    histPlaca: document.getElementById('sfHistPlaca'),
    btnClearHist: document.getElementById('sfBtnClearHist'),
    btnExportHist: document.getElementById('sfBtnExportHist'),
    histMeta: document.getElementById('sfHistMeta'),
    histTbody: document.getElementById('sfHistTbody'),

    // modal
    modal: document.getElementById('sfModal'),
    modalTitle: document.getElementById('sfModalTitle'),
    modalSub: document.getElementById('sfModalSub'),
    modalStatus: document.getElementById('sfModalStatus'),
    modalInicio: document.getElementById('sfModalInicio'),
    modalFim: document.getElementById('sfModalFim'),
    inputInicio: document.getElementById('sfInputInicio'),
    inputFim: document.getElementById('sfInputFim'),
    btnAddFalha: document.getElementById('sfBtnAddFalha'),
    btnReportar: document.getElementById('sfBtnReportar'),
    btnConcluir: document.getElementById('sfBtnConcluir'),
    btnRemover: document.getElementById('sfBtnRemover'),
    modalErr: document.getElementById('sfModalErr'),

    // indicador
    indicatorPanel: document.getElementById('sfIndicatorPanel'),
    btnFull: document.getElementById('sfBtnFull'),
    btnFullClose: document.getElementById('sfBtnFullClose'),
    toggleBtns: () => document.querySelectorAll('.sf-toggle-btn'),
    monthPick: document.getElementById('sfMonthPick'),
    weekPick: document.getElementById('sfWeekPick'),
    monthWrap: document.getElementById('sfMonthWrap'),
    weekWrap: document.getElementById('sfWeekWrap'),

    indRange: document.getElementById('sfIndRange'),
    chartTitle: document.getElementById('sfChartTitle'),
    chartHint: document.getElementById('sfChartHint'),
    weeklyWrap: document.getElementById('sfWeeklyWrap'),
    monthlyWrap: document.getElementById('sfMonthlyWrap'),
    weeklyCanvas: document.getElementById('sfWeeklyChart'),
    monthlyCanvas: document.getElementById('sfMonthlyChart'),

    pctValue: document.getElementById('sfPctValue'),
    pctSub: document.getElementById('sfPctSub'),
    pctFill: document.getElementById('sfPctFill'),
    cntFalha: document.getElementById('sfCntFalha'),
    cntReport: document.getElementById('sfCntReport'),
    cntConcl: document.getElementById('sfCntConcl'),

    badgeFalha: document.getElementById('sfBadgeFalha'),
    badgeReport: document.getElementById('sfBadgeReport'),
    badgeConcl: document.getElementById('sfBadgeConcl'),
    listFalha: document.getElementById('sfListFalha'),
    listReport: document.getElementById('sfListReport'),
    listConcl: document.getElementById('sfListConcl'),
  };

  let base = loadBase();
  let state = loadState();
  let hist = loadHist();

  let currentModalKey = null;
  let currentMode = 'weekly';
  let weeklyChart = null;
  let monthlyChart = null;
  let indicatorFull = false;

  const refreshMemory = () => { base = loadBase(); state = loadState(); hist = loadHist(); };

  const setView = (view) => {
    el.views.placas.classList.toggle('active', view === 'placas');
    el.views.historico.classList.toggle('active', view === 'historico');
    el.segBtns().forEach(b => b.classList.toggle('active', b.dataset.view === view));
  };

  const buildFiliais = (rows, empresaFilter) => {
    const filSet = new Set();
    for (const r of rows) {
      if (empresaFilter !== 'ALL' && r.empresa !== empresaFilter) continue;
      if (r.filial) filSet.add(r.filial);
    }
    return Array.from(filSet).sort((a,b)=>a.localeCompare(b,'pt-BR'));
  };

  const applyFilters = (rows) => {
    const emp = el.filterEmpresa.value;
    const fil = el.filterFilial.value;
    const q = normPlate(el.filterPlaca.value || '');

    return rows.filter(r => {
      if (emp !== 'ALL' && r.empresa !== emp) return false;
      if (fil !== 'ALL' && r.filial !== fil) return false;
      if (q && !r.placa.includes(q)) return false;
      return true;
    });
  };

  const renderFilters = () => {
    const rows = mergeBaseToRows(base);
    const emp = el.filterEmpresa.value || 'ALL';

    const filiais = buildFiliais(rows, emp);
    const current = el.filterFilial.value || 'ALL';

    el.filterFilial.innerHTML = `<option value="ALL">Todas</option>` + filiais.map(f => `<option value="${escapeAttr(f)}">${escapeHtml(f)}</option>`).join('');
    if (filiais.includes(current)) el.filterFilial.value = current;
    else el.filterFilial.value = 'ALL';
  };

  const renderPlacas = () => {
    refreshMemory();
    const rowsAll = mergeBaseToRows(base);
    renderFilters();

    const rows = applyFilters(rowsAll);
    el.baseStatus.textContent = `${rowsAll.length} placas carregadas`;
    el.listMeta.textContent = `${rows.length} exibidas`;

    const tbody = rows.map(r => {
      const key = r.empresa + '|' + r.placa;
      const st = state[key] || null;
      const status = st?.status || null;
      const ini = st?.inicio || null;
      const fim = st?.fim || null;

      return `
        <tr class="sf-row" data-key="${escapeAttr(key)}">
          <td><b>${escapeHtml(r.placa)}</b></td>
          <td>${escapeHtml(r.filial || '—')}</td>
          <td>${escapeHtml(r.empresa)}</td>
          <td>${statusPillHTML(status)}</td>
          <td>${escapeHtml(fmtBR(ini))}</td>
          <td>${escapeHtml(fmtBR(fim))}</td>
        </tr>
      `;
    }).join('');

    el.tbodyPlacas.innerHTML = tbody || `<tr><td colspan="6" style="padding:16px;color:#5b6b8b;">Nenhuma placa encontrada com esses filtros.</td></tr>`;

    el.tbodyPlacas.querySelectorAll('tr[data-key]').forEach(tr => {
      tr.addEventListener('click', () => openModal(tr.dataset.key));
    });

    renderHistorico();
    renderIndicator();
  };

  const renderHistorico = () => {
    refreshMemory();
    const status = el.histStatus.value;
    const q = normPlate(el.histPlaca.value || '');

    const rows = (hist || []).slice().sort((a,b)=> (b.ts||0) - (a.ts||0)).filter(h => {
      if (status !== 'ALL' && h.status !== status) return false;
      if (q && !String(h.placa||'').toUpperCase().includes(q)) return false;
      return true;
    });

    el.histMeta.textContent = `${rows.length} registro(s)`;
    el.histTbody.innerHTML = rows.map(h => `
      <tr>
        <td>${escapeHtml(h.tsText || '—')}</td>
        <td><b>${escapeHtml(h.placa || '—')}</b></td>
        <td>${escapeHtml(h.filial || '—')}</td>
        <td>${escapeHtml(h.empresa || '—')}</td>
        <td>${escapeHtml(labelAcao(h.status))}</td>
      </tr>
    `).join('') || `<tr><td colspan="5" style="padding:16px;color:#5b6b8b;">Sem registros.</td></tr>`;
  };

  const labelAcao = (st) => {
    if (st === 'falha') return 'Adicionar falha';
    if (st === 'reportada') return 'Marcar reportada';
    if (st === 'concluida') return 'Concluir';
    if (st === 'removida') return 'Remover';
    return '—';
  };

  const openModal = (key) => {
    refreshMemory();
    currentModalKey = key;

    const [empresa, placa] = key.split('|');
    const rowsAll = mergeBaseToRows(base);
    const row = rowsAll.find(r => (r.empresa + '|' + r.placa) === key) || { empresa, placa, filial:'' };
    const st = state[key] || { status:null, inicio:null, fim:null };

    el.modalTitle.textContent = row.placa;
    el.modalSub.textContent = `${row.empresa} • ${row.filial || '—'}`;
    el.modalStatus.textContent = st.status ? labelAcao(st.status) : 'Sem falha';
    el.modalInicio.textContent = fmtBR(st.inicio);
    el.modalFim.textContent = fmtBR(st.fim);

    el.inputInicio.value = st.inicio || '';
    el.inputFim.value = st.fim || '';

    hideModalErr();
    el.modal.classList.add('show');
    el.modal.setAttribute('aria-hidden','false');
  };

  const closeModal = () => {
    currentModalKey = null;
    hideModalErr();
    el.modal.classList.remove('show');
    el.modal.setAttribute('aria-hidden','true');
  };

  const showModalErr = (msg) => {
    el.modalErr.textContent = msg;
    el.modalErr.style.display = 'block';
  };
  const hideModalErr = () => {
    el.modalErr.textContent = '';
    el.modalErr.style.display = 'none';
  };

  const pushHist = ({ placa, filial, empresa, status }) => {
    const d = new Date();
    const ts = d.getTime();
    const tsText = `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()} ${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
    hist = loadHist();
    hist.push({ ts, tsText, placa, filial, empresa, status });
    saveHist(hist);
  };

  const updateState = (key, next) => {
    state = loadState();
    if (next === null) delete state[key];
    else state[key] = next;
    saveState(state);
  };

  const doAction = (type) => {
    hideModalErr();
    if (!currentModalKey) return;

    refreshMemory();
    const key = currentModalKey;
    const [empresa, placa] = key.split('|');
    const rowsAll = mergeBaseToRows(base);
    const row = rowsAll.find(r => (r.empresa + '|' + r.placa) === key) || { empresa, placa, filial:'' };
    const cur = state[key] || { status:null, inicio:null, fim:null, report:null };

    const inicioIn = el.inputInicio.value || null;
    const fimIn = el.inputFim.value || null;

    const commit = (newState, histStatus) => {
      const same =
        (cur?.status || null) === (newState?.status || null) &&
        (cur?.inicio || null) === (newState?.inicio || null) &&
        (cur?.fim || null) === (newState?.fim || null) &&
        (cur?.report || null) === (newState?.report || null);

      if (same) {
        showModalErr('Nada mudou (evita duplicar o histórico).');
        return;
      }

      updateState(key, newState);
      pushHist({ placa: row.placa, filial: row.filial, empresa: row.empresa, status: histStatus });

      closeModal();
      renderPlacas();
      renderIndicator();
    };

    if (type === 'falha') {
      if (!inicioIn) return showModalErr('Informe a data de início.');
      const newState = { status:'falha', inicio: inicioIn, fim: null, report: null };
      return commit(newState, 'falha');
    }

    if (type === 'reportada') {
      if (!cur?.inicio) return showModalErr('Essa placa não tem início de falha. Use “Adicionar Falha” primeiro.');
      const newState = { status:'reportada', inicio: cur.inicio, fim: null, report: cur.report || todayISO() };
      return commit(newState, 'reportada');
    }

    if (type === 'concluida') {
      if (!cur?.inicio) return showModalErr('Essa placa não tem início de falha. Use “Adicionar Falha” primeiro.');
      const fim = fimIn || todayISO();
      if (fim < cur.inicio) return showModalErr('Data de fim não pode ser menor que a data de início.');
      const newState = { status:'concluida', inicio: cur.inicio, fim, report: cur.report || null };
      return commit(newState, 'concluida');
    }

    if (type === 'remover') {
      if (!state[key]) return showModalErr('Essa placa não tem falha registrada.');
      return commit(null, 'removida');
    }
  };

  /* ===========================
     IMPORT robusto
  ============================ */
  const findHeaderKey = (keys, cands) => {
    const lowKeys = keys.map(k => ({ k, l: String(k).toLowerCase().trim() }));
    for (const cand of cands) {
      const c = cand.toLowerCase();
      const hit = lowKeys.find(x => x.l === c || x.l.replace(/\s+/g,'') === c.replace(/\s+/g,''));
      if (hit) return hit.k;
    }
    for (const cand of cands) {
      const c = cand.toLowerCase();
      const hit = lowKeys.find(x => x.l.includes(c));
      if (hit) return hit.k;
    }
    return null;
  };

  const normalizeImportedRows = (rowsRaw) => {
    const out = [];
    for (const r of rowsRaw || []) {
      const placa = normPlate(r.placa);
      if (!placa) continue;
      out.push({ placa, filial: normStr(r.filial || '') });
    }
    const map = new Map();
    for (const r of out) {
      const k = r.placa;
      if (!map.has(k)) map.set(k, r);
      else {
        const cur = map.get(k);
        if (!cur.filial && r.filial) map.set(k, r);
      }
    }
    return Array.from(map.values());
  };

  const parseCSV = async (file) => {
    const text = await file.text();
    const lines = text.split(/\r?\n/).filter(l => l.trim().length);
    if (!lines.length) return [];

    const first = lines[0];
    const delim = first.includes(';') ? ';' : (first.includes('\t') ? '\t' : ',');
    const headers = first.split(delim).map(h => h.trim());
    const keys = headers;

    const kPlaca = findHeaderKey(keys, ['placa','PLACA','plate','numero de registro','número de registro','registro']);
    const kFilial = findHeaderKey(keys, ['filial','FILIAL','garagem','GARAGEM','planta','PLANTA','base','regional','local']);

    const rows = [];
    for (let i=1;i<lines.length;i++){
      const cols = lines[i].split(delim);
      if (!cols.length) continue;

      const get = (idx) => (idx >= 0 && idx < cols.length) ? cols[idx].trim() : '';
      const idxPlaca = kPlaca ? headers.indexOf(kPlaca) : -1;
      const idxFilial = kFilial ? headers.indexOf(kFilial) : -1;

      const placa = normPlate(idxPlaca >= 0 ? get(idxPlaca) : get(0));
      const filial = normStr(idxFilial >= 0 ? get(idxFilial) : get(1));

      if (!placa) continue;
      rows.push({ placa, filial });
    }
    return normalizeImportedRows(rows);
  };

  const parseXLSXFile = async (file) => {
    if (!hasXLSX()) throw new Error('Biblioteca XLSX não carregou (CDN).');
    const buf = await file.arrayBuffer();
    const wb = XLSX.read(buf, { type:'array' });
    const ws = wb.Sheets[wb.SheetNames[0]];
    if (!ws) return [];

    const json = XLSX.utils.sheet_to_json(ws, { defval:'', raw:false });
    if (json && json.length) {
      const keys = Object.keys(json[0] || {});
      const kPlaca = findHeaderKey(keys, ['placa','PLACA','plate','numero de registro','número de registro','registro']);
      const kFilial = findHeaderKey(keys, ['filial','FILIAL','garagem','GARAGEM','planta','PLANTA','base','regional','local']);

      if (!kPlaca) {
        const matrix = XLSX.utils.sheet_to_json(ws, { header: 1, defval:'' });
        return parseMatrixFallback(matrix);
      }

      const rows = [];
      for (const r of json) {
        const placa = normPlate(r[kPlaca] ?? r['PLACA'] ?? r['placa']);
        if (!placa) continue;
        const filial = normStr(
          (kFilial ? (r[kFilial]) : '') ??
          r['FILIAL'] ?? r['filial'] ?? r['GARAGEM'] ?? r['garagem'] ?? r['PLANTA'] ?? r['planta']
        );
        rows.push({ placa, filial });
      }
      return normalizeImportedRows(rows);
    }

    const matrix = XLSX.utils.sheet_to_json(ws, { header: 1, defval:'' });
    return parseMatrixFallback(matrix);
  };

  const parseMatrixFallback = (matrix) => {
    const rows = [];
    if (!matrix || matrix.length === 0) return rows;

    const m = matrix.filter(row => Array.isArray(row) && row.some(c => String(c ?? '').trim() !== ''));
    if (!m.length) return rows;

    let headerRowIdx = -1;
    for (let i=0; i<Math.min(m.length, 10); i++){
      const row = m[i].map(c => String(c ?? '').toLowerCase());
      if (row.some(c => c.includes('placa') || c.includes('plate') || c.includes('registro'))) {
        headerRowIdx = i;
        break;
      }
    }

    if (headerRowIdx >= 0) {
      const header = m[headerRowIdx].map(c => String(c ?? '').trim());
      const idxPlaca = header.findIndex(h => {
        const l = h.toLowerCase();
        return l.includes('placa') || l.includes('plate') || l.includes('registro');
      });
      const idxFilial = header.findIndex(h => ['filial','garagem','planta','base','regional','local'].some(x => h.toLowerCase().includes(x)));

      for (let i=headerRowIdx+1; i<m.length; i++){
        const row = m[i];
        const placa = normPlate(row[idxPlaca] ?? row[0] ?? '');
        if (!placa) continue;
        const filial = normStr(row[(idxFilial >= 0 ? idxFilial : 1)] ?? '');
        rows.push({ placa, filial });
      }
      return normalizeImportedRows(rows);
    }

    const firstRowStr = (m[0] || []).join(' ').toLowerCase();
    const start = (firstRowStr.includes('placa') || firstRowStr.includes('filial') || firstRowStr.includes('garagem') || firstRowStr.includes('registro')) ? 1 : 0;

    for (let i=start; i<m.length; i++){
      const row = m[i];
      const placa = normPlate(row[0] ?? '');
      if (!placa) continue;
      const filial = normStr(row[1] ?? '');
      rows.push({ placa, filial });
    }
    return normalizeImportedRows(rows);
  };

  const loadRepoFile = async (url) => {
    if (!hasXLSX()) throw new Error('Biblioteca XLSX não carregou (CDN).');
    const res = await fetch(url, { cache:'no-store' });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const buf = await res.arrayBuffer();
    const wb = XLSX.read(buf, { type:'array' });
    const ws = wb.Sheets[wb.SheetNames[0]];
    if (!ws) return [];

    const json = XLSX.utils.sheet_to_json(ws, { defval:'', raw:false });
    if (json && json.length) {
      const keys = Object.keys(json[0] || {});
      const kPlaca = findHeaderKey(keys, ['placa','PLACA','plate','numero de registro','número de registro','registro']);
      const kFilial = findHeaderKey(keys, ['filial','FILIAL','garagem','GARAGEM','planta','PLANTA','base','regional','local']);

      const rows = [];
      for (const r of json) {
        const placa = normPlate(r[kPlaca] ?? r['PLACA'] ?? r['placa'] ?? '');
        if (!placa) continue;
        const filial = normStr(
          (kFilial ? (r[kFilial]) : '') ??
          r['FILIAL'] ?? r['filial'] ?? r['GARAGEM'] ?? r['garagem'] ?? r['PLANTA'] ?? r['planta']
        );
        rows.push({ placa, filial });
      }
      return normalizeImportedRows(rows);
    }

    const matrix = XLSX.utils.sheet_to_json(ws, { header: 1, defval:'' });
    return parseMatrixFallback(matrix);
  };

  const importFromFile = async (file, target) => {
    const name = (file?.name || '').toLowerCase();
    const isCSV = name.endsWith('.csv');

    Toast.show(`Importando ${target}...`, file?.name || '', '');

    let rows = [];
    if (isCSV) rows = await parseCSV(file);
    else rows = await parseXLSXFile(file);

    if (!rows.length) {
      Toast.show(`Importação ${target} não gerou linhas.`, 'Arquivo sem dados ou colunas não reconhecidas.', 'err');
      return null;
    }

    base = loadBase();
    if (target === 'WIKI') base.wiki = rows;
    if (target === 'TELEMATIX') base.telematix = rows;
    saveBase(base);

    Toast.show(`Importação ${target} concluída!`, `${rows.length} placa(s) carregadas.`, 'ok');

    renderPlacas();
    return rows.length;
  };

  /* ===========================
     Indicador (gráfico + listas)
  ============================ */
  const setIndicatorFullscreen = (on) => {
    indicatorFull = !!on;
    el.indicatorPanel.classList.toggle('sf-fullscreen', indicatorFull);
    el.btnFull.style.display = indicatorFull ? 'none' : 'inline-flex';
    el.btnFullClose.style.display = indicatorFull ? 'inline-flex' : 'none';
  };

  const getSelectedMonth = () => {
    const v = el.monthPick.value;
    if (v && v.includes('-')) {
      const [y,m] = v.split('-').map(Number);
      return { y, m };
    }
    const d = new Date();
    return { y: d.getFullYear(), m: d.getMonth()+1 };
  };

  const rebuildWeekOptions = () => {
    const { y, m } = getSelectedMonth();
    const ranges = getWeekRangesInMonth(y, m);
    const mName = monthNames[m-1] || 'MES';

    el.weekPick.innerHTML = ranges.map((r, idx) => {
      const label = `${r.label} ${mName}`;
      return `<option value="${idx}">${label}</option>`;
    }).join('');

    if (el.weekPick.options.length) el.weekPick.value = '0';
  };

  const getSelectedWeeklyRange = () => {
    const { y, m } = getSelectedMonth();
    const ranges = getWeekRangesInMonth(y, m);
    const idx = Math.max(0, Math.min(Number(el.weekPick.value || 0), ranges.length-1));
    const r = ranges[idx] || ranges[0] || { label:'S1', s:1, e:7 };
    const startISO = isoFromYMD(y, m, r.s);
    const endISO = isoFromYMD(y, m, r.e);
    const label = `${r.label} ${monthNames[m-1]} (${pad2(r.s)}/${pad2(m)}/${y} a ${pad2(r.e)}/${pad2(m)}/${y})`;
    return { startISO, endISO, label, r };
  };

  const getMonthlyRanges = () => {
    const { y, m } = getSelectedMonth();
    const ranges = getWeekRangesInMonth(y, m);
    const full = ranges.map(r => ({
      ...r,
      startISO: isoFromYMD(y, m, r.s),
      endISO: isoFromYMD(y, m, r.e),
      label: r.label
    }));
    return { y, m, ranges: full };
  };

  // ======= (mantém teu compute, só usa pra listas/contagens) =======
  const computeCountsForRange = (startISO, endISO) => {
    refreshMemory();
    const rowsAll = mergeBaseToRows(base);

    // mapa: ultima data (ISO) em que a placa virou "reportada"
    const repMap = new Map();
    const hh = Array.isArray(hist) ? hist : loadHist();

    const pad2loc = n => String(n).padStart(2,'0');
    const tsToISO = (ts) => {
      const d = new Date(ts);
      return `${d.getFullYear()}-${pad2loc(d.getMonth()+1)}-${pad2loc(d.getDate())}`;
    };

    for (const h of hh) {
      if (h.status !== 'reportada') continue;
      const emp = String(h.empresa || '').toUpperCase();
      const pla = String(h.placa || '').toUpperCase();
      if (!emp || !pla) continue;

      const k = emp + '|' + pla;
      const ts = Number(h.ts || 0);
      const prev = repMap.get(k);
      if (!prev || ts > prev.ts) repMap.set(k, { ts, iso: tsToISO(ts) });
    }

    const falha = [];
    const report = [];
    const concl = [];

    for (const r of rowsAll) {
      const key = r.empresa + '|' + r.placa;
      const st = state[key];
      if (!st || !st.inicio) continue;

      const ini = st.inicio;          // início da falha (escolhido no modal)
      const fim = st.fim || null;     // data de conclusão (quando concluída)
      const repISO = st.report || (repMap.get(key)?.iso || null); // dia que virou reportada

      // fora do período selecionado
      if (ini > endISO) continue;
      if (fim && fim < startISO) continue;

      // "foto" do status no período:
      let evalISO = endISO;
      if (fim && fim < evalISO) evalISO = fim;
      if (evalISO < ini) continue;

      let status = 'falha';
      if (fim && evalISO === fim) status = 'concluida';
      else if (repISO && repISO >= ini && repISO <= evalISO) status = 'reportada';
      else status = 'falha';

      const item = { ...r, ...st, report: repISO || null };

      if (status === 'falha') falha.push(item);
      else if (status === 'reportada') report.push(item);
      else if (status === 'concluida') concl.push(item);
    }

    return { falha, report, concl };
  };

  // ======= NOVA REGRA DO % (20 dias) =======
  const computePctByRule = (falhaArr, reportArr, endISO) => {
    // 1) qualquer falha NÃO reportada no período => 0%
    if ((falhaArr || []).length > 0) {
      return { pct: 0, reason: 'Falha não reportada no período' };
    }

    // 2) qualquer falha reportada com > 20 dias (desde o INÍCIO) => 0%
    const over20 = (reportArr || []).some(it => diffDaysInclusive(it.inicio, endISO) > 20);
    if (over20) {
      return { pct: 0, reason: 'Falha reportada há mais de 20 dias (desde o início)' };
    }

    // 3) abaixo disso => 100%
    if ((reportArr || []).length > 0) return { pct: 1, reason: 'Somente falhas reportadas (≤ 20 dias)' };
    return { pct: 1, reason: 'Sem falhas' };
  };

  const renderStatusList = (container, arr, showSince) => {
    container.innerHTML = arr.slice()
      .sort((a,b)=> (a.placa||'').localeCompare(b.placa||'', 'pt-BR'))
      .map(it => `
        <div class="sf-item">
          <div class="left">
            <b>${escapeHtml(it.placa)}</b>
            <span>${escapeHtml(it.filial || '—')} • ${escapeHtml(it.empresa || '—')}</span>
          </div>
          <div class="since">${showSince ? escapeHtml(fmtBR(it.inicio || it.fim)) : ''}</div>
        </div>
      `).join('') || `<div style="padding:10px;color:#5b6b8b;">Nenhuma</div>`;
  };

  // ======= KPI ajustado (0%/100% pela regra) =======
  const renderKpis = (pct01, reason, falhaN, repN, conclN) => {
    const pctTxt = `${Math.round(pct01 * 100)}%`;

    el.pctValue.textContent = pctTxt;
    el.pctSub.textContent = `${reason} • ${falhaN} falha • ${repN} reportada • ${conclN} resolvida`;
    el.pctFill.style.width = `${Math.round(pct01 * 100)}%`;

    el.cntFalha.textContent = falhaN;
    el.cntReport.textContent = repN;
    el.cntConcl.textContent = conclN;

    el.badgeFalha.textContent = falhaN;
    el.badgeReport.textContent = repN;
    el.badgeConcl.textContent = conclN;
  };

  const renderWeeklyChart = (falhaN, repN, conclN) => {
    if (!window.Chart) return;
    const ctx = el.weeklyCanvas.getContext('2d');
    if (weeklyChart) weeklyChart.destroy();

    weeklyChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['Falha', 'Reportada', 'Resolvida'],
        datasets: [{
          label: 'Qtde',
          data: [falhaN, repN, conclN],
          backgroundColor: ['#b00020', '#ff8c00', '#1f8a3a'],
          borderWidth: 0,
          borderRadius: 8
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true, ticks: { precision:0 } } }
      }
    });
  };

  const renderMonthlyChart = (weekLabels, dataFalha, dataRep, dataConcl) => {
    if (!window.Chart) return;
    const ctx = el.monthlyCanvas.getContext('2d');
    if (monthlyChart) monthlyChart.destroy();

    monthlyChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: weekLabels,
        datasets: [
          { label:'Falha', data: dataFalha, backgroundColor:'#b00020', borderRadius: 8 },
          { label:'Reportada', data: dataRep, backgroundColor:'#ff8c00', borderRadius: 8 },
          { label:'Resolvida', data: dataConcl, backgroundColor:'#1f8a3a', borderRadius: 8 },
        ]
      },
      options: {
        responsive: true,
        plugins: { legend: { position: 'bottom' } },
        scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true, ticks: { precision:0 } } }
      }
    });
  };

  const renderIndicator = () => {
    refreshMemory();

    el.toggleBtns().forEach(b => b.classList.toggle('active', b.dataset.mode === currentMode));

    if (currentMode === 'weekly') {
      el.chartTitle.textContent = 'Semanal';
      el.chartHint.textContent = 'Contagem por status (semana selecionada)';
      el.weekWrap.style.display = '';
      el.weeklyWrap.style.display = '';
      el.monthlyWrap.style.display = 'none';
    } else {
      el.chartTitle.textContent = 'Mensal';
      el.chartHint.textContent = 'Barras empilhadas por semana do mês';
      el.weekWrap.style.display = 'none';
      el.weeklyWrap.style.display = 'none';
      el.monthlyWrap.style.display = '';
    }

    if (currentMode === 'weekly') {
      const w = getSelectedWeeklyRange();
      el.indRange.textContent = w.label;

      const { falha, report, concl } = computeCountsForRange(w.startISO, w.endISO);

      const rule = computePctByRule(falha, report, w.endISO);
      renderKpis(rule.pct, rule.reason, falha.length, report.length, concl.length);

      renderStatusList(el.listFalha, falha, true);
      renderStatusList(el.listReport, report, true);
      renderStatusList(el.listConcl, concl, true);

      renderWeeklyChart(falha.length, report.length, concl.length);
    } else {
      const { y, m, ranges } = getMonthlyRanges();
      el.indRange.textContent = `${monthNames[m-1]} ${y}`;

      const weekLabels = ranges.map(r => r.label);
      const dataFalha = [];
      const dataRep = [];
      const dataConcl = [];

      const monthStart = isoFromYMD(y, m, 1);
      const monthEnd = isoFromYMD(y, m, new Date(y, m, 0).getDate());
      const monthAgg = computeCountsForRange(monthStart, monthEnd);

      const rule = computePctByRule(monthAgg.falha, monthAgg.report, monthEnd);
      renderKpis(rule.pct, rule.reason, monthAgg.falha.length, monthAgg.report.length, monthAgg.concl.length);

      renderStatusList(el.listFalha, monthAgg.falha, true);
      renderStatusList(el.listReport, monthAgg.report, true);
      renderStatusList(el.listConcl, monthAgg.concl, true);

      for (const r of ranges) {
        const c = computeCountsForRange(r.startISO, r.endISO);
        dataFalha.push(c.falha.length);
        dataRep.push(c.report.length);
        dataConcl.push(c.concl.length);
      }

      renderMonthlyChart(weekLabels, dataFalha, dataRep, dataConcl);
    }

    setIndicatorFullscreen(indicatorFull);
  };

  /* ===========================
     escape helpers
  ============================ */
  function escapeHtml(s) {
    return String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }
  function escapeAttr(s) { return escapeHtml(s).replace(/"/g,'&quot;'); }

  /* ===========================
     bind UI
  ============================ */
  const bind = () => {
    // sub-tabs placas/hist
    el.segBtns().forEach(btn => btn.addEventListener('click', () => setView(btn.dataset.view)));

    // filtros placas
    el.filterEmpresa.addEventListener('change', () => { renderFilters(); renderPlacas(); });
    el.filterFilial.addEventListener('change', () => renderPlacas());
    el.filterPlaca.addEventListener('input', () => renderPlacas());
    el.btnClearFilters.addEventListener('click', () => {
      el.filterEmpresa.value = 'ALL';
      el.filterFilial.value = 'ALL';
      el.filterPlaca.value = '';
      renderPlacas();
    });

    // histórico
    el.histStatus.addEventListener('change', () => renderHistorico());
    el.histPlaca.addEventListener('input', () => renderHistorico());
    el.btnClearHist.addEventListener('click', () => {
      el.histStatus.value = 'ALL';
      el.histPlaca.value = '';
      renderHistorico();
    });
    el.btnExportHist.addEventListener('click', () => {
      const data = JSON.stringify(loadHist(), null, 2);
      const blob = new Blob([data], { type:'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `historico_falha_sinal_${todayISO()}.json`;
      a.click();
      URL.revokeObjectURL(a.href);
      Toast.show('Histórico exportado!', a.download, 'ok');
    });

    // modal close (backdrop + X + ESC)
    el.modal.addEventListener('click', (e) => {
      const t = e.target;
      if (t && t.dataset && t.dataset.close === '1') closeModal();
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        if (el.modal.classList.contains('show')) closeModal();
        if (indicatorFull) setIndicatorFullscreen(false);
      }
    });

    // ações modal
    el.btnAddFalha.addEventListener('click', () => doAction('falha'));
    el.btnReportar.addEventListener('click', () => doAction('reportada'));
    el.btnConcluir.addEventListener('click', () => doAction('concluida'));
    el.btnRemover.addEventListener('click', () => doAction('remover'));

    // indicador toggle
    el.toggleBtns().forEach(btn => btn.addEventListener('click', () => {
      currentMode = btn.dataset.mode;
      renderIndicator();
    }));

    // mês/semana
    const now = new Date();
    const mm = `${now.getFullYear()}-${pad2(now.getMonth()+1)}`;
    el.monthPick.value = mm;
    rebuildWeekOptions();

    el.monthPick.addEventListener('change', () => {
      rebuildWeekOptions();
      renderIndicator();
    });
    el.weekPick.addEventListener('change', () => renderIndicator());

    // fullscreen
    el.btnFull.addEventListener('click', () => setIndicatorFullscreen(true));
    el.btnFullClose.addEventListener('click', () => setIndicatorFullscreen(false));

    // ===== IMPORT FILE =====
    const armInputReset = (inputEl) => inputEl.addEventListener('click', () => { inputEl.value = ''; });
    armInputReset(el.fileWiki);
    armInputReset(el.fileTele);

    el.fileWiki.addEventListener('change', async () => {
      const f = el.fileWiki.files && el.fileWiki.files[0];
      if (!f) return;
      try {
        el.baseStatus.textContent = 'Importando WIKI...';
        const n = await importFromFile(f, 'WIKI');
        if (n) el.baseStatus.textContent = `WIKI importada: ${n} placa(s)`;
      } catch (e) {
        el.baseStatus.textContent = 'Falha ao importar WIKI';
        Toast.show('Falha ao importar WIKI.', (e && (e.message || String(e))) || 'Erro desconhecido', 'err');
      }
    });

    el.fileTele.addEventListener('change', async () => {
      const f = el.fileTele.files && el.fileTele.files[0];
      if (!f) return;
      try {
        el.baseStatus.textContent = 'Importando TELEMATIX...';
        const n = await importFromFile(f, 'TELEMATIX');
        if (n) el.baseStatus.textContent = `TELEMATIX importada: ${n} placa(s)`;
      } catch (e) {
        el.baseStatus.textContent = 'Falha ao importar TELEMATIX';
        Toast.show('Falha ao importar TELEMATIX.', (e && (e.message || String(e))) || 'Erro desconhecido', 'err');
      }
    });

    el.btnLoadRepo.addEventListener('click', async () => {
      try {
        if (!hasXLSX()) {
          Toast.show('XLSX não carregou (CDN).', 'Sem XLSX não consigo ler .xlsx do repositório.', 'err');
          return;
        }
        el.baseStatus.textContent = 'Carregando do repositório...';
        Toast.show('Carregando base do repositório...', '/data/WIKIPLACAS.xlsx e /data/TELEMATIXPLACAS.xlsx', '');

        const [w, t] = await Promise.all([
          loadRepoFile('/data/WIKIPLACAS.xlsx'),
          loadRepoFile('/data/TELEMATIXPLACAS.xlsx')
        ]);

        base = { wiki: w, telematix: t };
        saveBase(base);

        Toast.show('Base atualizada!', `WIKI: ${w.length} • TELEMATIX: ${t.length}`, 'ok');
        renderPlacas();
      } catch (e) {
        el.baseStatus.textContent = 'Falha ao carregar base';
        Toast.show('Falha ao carregar do repositório.', (e && (e.message || String(e))) || 'Erro desconhecido', 'err');
      }
    });

    if (!hasXLSX()) {
      Toast.show('Atenção: XLSX não carregou.', 'Se for rede bloqueando CDN, import .xlsx não vai funcionar (CSV funciona).', 'err');
    }
  };

  const init = () => {
    bind();
    setView('placas');
    renderPlacas();
    setIndicatorFullscreen(false);
  };

  return { init, renderPlacas, renderHistorico, renderIndicator };
})();

/* helpers globais */
function escapeHtml(s){ return String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function escapeAttr(s){ return escapeHtml(s).replace(/"/g,'&quot;'); }

/* inicia */
SF.init();
</script>
</body>
</html>
